\documentclass[epsfig,11pt]{article}
\usepackage[english]{babel} % Using babel for hyphenation
\usepackage{lmodern} % Changing the font
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

\usepackage{listings}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{epsfig}
\usepackage[parfill]{parskip} % Removes indents
\usepackage{color}
\usepackage{framed}
\usepackage{vmargin}
\usepackage{wrapfig}
\setpapersize{A4}

\definecolor{red}{rgb}{1,0.1,0}

\newcommand{\inr}[1]{ \Big \langle #1 \Big \rangle}
\newcommand\pd[2][]{\ensuremath{\frac{\partial#1}{\partial#2}}} 

\title{Applications of finite element methods in biomechanics}
\author{Krister Stræte Karlsen}

% Define colors for python code 
\definecolor{Code}{rgb}{0,0,0}
\definecolor{Decorators}{rgb}{0.5,0.5,0.5}
\definecolor{Numbers}{rgb}{0.5,0,0}
\definecolor{MatchingBrackets}{rgb}{0.25,0.5,0.5}
\definecolor{Keywords}{rgb}{0,0,1}
\definecolor{self}{rgb}{0,0,0}
\definecolor{Strings}{rgb}{0,0.63,0}
\definecolor{Comments}{rgb}{0,0.63,1}
\definecolor{Backquotes}{rgb}{0,0,0}
\definecolor{Classname}{rgb}{0,0,0}
\definecolor{FunctionName}{rgb}{0,0,0}
\definecolor{Operators}{rgb}{0,0,0}
\definecolor{Background}{rgb}{0.98,0.98,0.98}

\lstnewenvironment{python}[1][]{
\lstset{
numbers=left,
breaklines=true
numberstyle=\footnotesize,
numbersep=1em,
xleftmargin=1em,
framextopmargin=2em,
framexbottommargin=2em,
showspaces=false,
showtabs=false,
showstringspaces=false,
frame=l,
tabsize=4,
% Basic
basicstyle=\ttfamily ,
backgroundcolor=\color{Background},
language=Python,
% Comments
commentstyle=\color{Comments}\slshape,
% Strings
stringstyle=\color{Strings},
morecomment=[s][\color{Strings}]{"""}{"""},
morecomment=[s][\color{Strings}]{'''}{'''},
% keywords
morekeywords={import,from,class,def,for,while,if,is,in,elif,else,not,and,or,print,break,continue,return,True,False,None,access,as,,del,except,exec,finally,global,import,lambda,pass,print,raise,try,assert},
keywordstyle={\color{Keywords}\bfseries},
% additional keywords
morekeywords={[2]@invariant},
keywordstyle={[2]\color{Decorators}\slshape},
emph={self},
emphstyle={\color{self}\slshape},
%
}}{}

\begin{document}

\maketitle

\section{Blood flow in zebrafish}

Since the 1960s, the zebrafish has become increasingly important to scientific research. It has many characteristics that make it a valuable model for studying human genetics and disease. It was the first vertebrate to be cloned and is particularly notable for its regenerative abilities. Zebrafish have a similar genetic structure to humans. They share 70 per cent of genes with us and they are cheaper to maintain than mice. The zebrafish adult is about 2.5 cm to 4 cm long. 

\begin{wrapfigure}{r}{0.5\textwidth}
  \begin{center}
    \includegraphics[width=0.4\textwidth]{zebrafish.png}
  \end{center}
  \caption{Stages of zebrafish development.}
\end{wrapfigure}

To study the effect of different drugs being able to model the blood flow is important. For instance, if the drug actually never reaches the infected cells a potentially effective drug might be considered ineffective on wrong ground. Due to ethical reasons all experiments on zebrafish must be done at an very early stage of its development.


\subsection{Measurement of blood velocities in zebrafish}

The small and transparent zebrafish embryo provides an ideal animal model to get high-resolution imaging of vessels. In \cite{fieramonti2015quantitative} a method referred to as \emph{optical vector field tomography} is used to map in 3D the velocity of blood cells in the zebrafish vascular network. 

\begin{figure}[h!] 
\begin{center}
  \includegraphics[scale=0.5]{blood_velocities.png}
  \end{center}
  \caption{Some of results from \cite{fieramonti2015quantitative}.}
\end{figure}

\textbf{Suggested project:} Very little is known about the pressure gradients driving the blood flows in zebrafish. With knowledge of the velocities from \cite{fieramonti2015quantitative}, a mesh of geometry and a suitable model for the blood flow, do numerical experiments to find approximate values of the pressure gradients in zebrafish.

\subsection{Generating mesh from original MRI images}

{\color{red} Kent: Kan du si noe om hva slags bilder dette er?}

Starting from \texttt{original\_zebrafish.vti} a finite element method mesh can be created using a software called \emph{The Vascular Modeling Toolkit(VMTK)}. VMTK is a collection of libraries and tools for 3D reconstruction, geometric analysis, mesh generation and surface data analysis for image-based modeling of blood vessels. To install VMTK go to 

\texttt{http://www.vmtk.org/download/}

and grab the development version in a few simple steps:

- Clone the git repository: \texttt{https://github.com/vmtk/vmtk.git}

- Create a build directory and cd into it

- Run \texttt{cmake ../vmtk} with the directory where the vmtk source tree is located as an argument 

- Start the compiler in your build directory by running \texttt{make}

Next, the steps needed to create a mesh from the image-file is outlined. The reader is advised to experiment with the different parameteres used in the scripts, and the parameters suggested here should serve as a staring point. For more information see \texttt{http://www.vmtk.org/tutorials/}.



1) Select a volume of interest(VOI)
\begin{framed}       
    \texttt{vmtkimagevoiselector -ifile original.vti -ofile voi.vti}
\end{framed}
2) Segmentation (this is the tricky and time consuming part)
\begin{framed}       
    \texttt{vmtklevelsetsegmentation -ifile voi.vti -ofile levelsets.vti}
\end{framed}
3) Create surface file
\begin{framed}       
    \texttt{vmtkmarchingcubes -ifile levelsets.vti -ofile surf.vtp}
\end{framed}
4) Smoothing of surface
\begin{framed}       
    \texttt{dvmtksurfacesmoothing -ifile surf.vtp -passband 0.1 -iterations 30 -ofile sm\_surf.vtp}
\end{framed}
5) Clip surface
\begin{framed}       
    \texttt{vmtksurfaceclipper -ifile sm\_surf.vtp -ofile cl\_surface.vtp}
\end{framed}
6) Generate mesh
\begin{framed}       
    \texttt{vmtkmeshgenerator -ifile cl\_surface.vtp -ofile zebramesh.vtu -edgelength
1.0}
\end{framed}
7) Convert to dolfin-format
\begin{framed}       
    \texttt{vmtkmeshwriter -ifile zebramesh.vtu -entityidsarray CellEntityIds -ofile zebra\_mesh.xml}
\end{framed}


 \begin{figure}[h!] 
\begin{center}
  \includegraphics[scale=0.3]{overview2.png}
  \end{center}
  \caption{The circulatory system of a zebrafish where a small part is meshed.}
\end{figure}

\begin{figure}[h!] 
\begin{center}
  \includegraphics[scale=0.3]{zoomed2.png}
  \end{center}
  \caption{Zooming in to see the meshed region.}
\end{figure}


\subsection{Mathematical formulation}

The blood velocities in a zebrafish are low thus using \emph{Stokes flow} as a model is a fair approximation.

For for geometries with lots of cells using $P_1-P_1$ formulations saves a lot of time and memory, and to even be able to run simulations on your own computer with the \texttt{zebrafish.xml} mesh such a formulation is needed. 

Find $u,p \in W,\: W = V \times Q $ such that
\begin{align*}
a((u,p),(v,q)) = L((v,q)) \quad \forall \quad v,q \in W 
\end{align*}
where
\begin{align*}
a((u,p),(v,q)) &= \int_\Omega \nabla u : \nabla v - (\nabla \cdot v)p + (\nabla \cdot u)q + \epsilon \nabla q \cdot \nabla p \: dx \\
L((v,q)) &= \int_\Omega  (v + \epsilon \nabla q) \cdot f \: dx
\end{align*}
Here \(\epsilon = \beta h^2\) and \(\beta\) is some number and \(h\) is the mesh cell size.

Boundary conditions:
\begin{align*}
u = 0 \quad &on \quad \partial \Omega_{\text{ no-slip}} \\
\sigma \cdot \mathbf{n} = p_i\mathbf{n} \quad &on \quad \partial \Omega_\text{ opening(i)},\quad i=1,..,5
\end{align*}

\subsection{Results}


\begin{figure}[h!] 
\begin{center}
  \includegraphics[scale=0.4]{result.png}
  \end{center}
  \caption{Zooming in to see the meshed region.}
\end{figure}


\section{Squeezing a postdoc's brain}

We would very much like to squeeze postdoc Erika Lindström's brain. Since she has refused to let us do this with our hands in her office, we must do this on a computer using her brain as our computational domain. The brain will be deformed as a result of the squeezing and to capture this effect we will use a \emph{linear elastic} model. 

A mesh of Erika's brain can be found in the git repository:
 https://github.com/krikarls/fun-with-fem. 
 

The brain is not clamped in the skull, but in a sense floating around. This means that we must employ \emph{neumann boundary conditions} on the entire boundary. As we know, there are no unique solution to such a problem since all \emph{rigid motions} satify the equation. So in order to obtain a unique solution we must remove all rigid motions. All the possible rigid motions in 3D are: translations in $x,y,z$-direction and rotations around the corresponding axes. Thus six in total.

An example using \emph{FEniCS} on how to remove these can be found in the same repository as the brain mesh. 

\subsection{Paraview}
\emph{ParaView} is an great open-source, multi-platform data analysis and visualization software. For instance results and other data obtained using \emph{FEniCS} can be studied in more detial with ParaView.  

\subsubsection{Load/save state}

Being able to save your work, and later load it, properly is important. This is done using the \emph{save/load state} function in ParaView. If you are switching between computers, or collaborating with others, this might not work, but luckily there is an easy fix. The problem is that the state file contains information about specific path to the location to which it was saved. 

As an example, let's try to open the state file  \texttt{screen\_shot.pvsm} from where Figure [] is taken. ParaView will very likely give you an error. To fix this open the file in some text editor, search for parts of original path, something like "/home.." and you will find lines like 

\texttt{<Element index="0"value="/home/krister/ ..../deformed\_brain.pvd"/>}

Replace 


\subsection{Mathematical formulation}

Find $u$ such that 
\begin{align*}
  \int_\Omega  2\mu (\epsilon(u) : \epsilon(v))  +\lambda (\nabla \cdot u) (\nabla \cdot v) \: dx = \int_\Omega f \cdot v \: dx \quad \forall v \in V
\end{align*} 

Boundary conditions
\begin{align*}
\sigma \cdot \mathbf{n} = p\mathbf{n} \quad &on \quad \partial \Omega
\end{align*}

The material parameters for Erika's brain are $E = 16000 $ Pa and $\nu = 0.25$. The Lamè coefficients can be computed according to 
\begin{align*}
\lambda = \frac{E \nu}{(1-2\nu)(1+\nu)} \quad and \quad \mu = \frac{E}{2(1+\nu)}.
\end{align*}

\subsection{Implementation}

\begin{python}
from fenics import *

mesh = Mesh('mesh/res32.xdmf')	# mm

plot(mesh,interactive=True)

# Since the mesh is in mm pressure units in pascal must be scaled by alpha = (1e6)**(-1)
alpha = (1e6)**(-1)

# Mark boundaries
class Neumann_boundary(SubDomain):
	def inside(self, x, on_boundry):
		return on_boundry

mf = FacetFunction("size_t", mesh)
mf.set_all(0)

Neumann_boundary().mark(mf, 1)
ds = ds[mf]

# Continuum mechanics
E = 16*1e3 *alpha
nu = 0.25
mu, lambda_ = Constant(E/(2*(1 + nu))), Constant(E*nu/((1 + nu)*(1 - 2*nu)))
epsilon = lambda u: sym(grad(u))

p_outside = 133 *alpha
n = FacetNormal(mesh)
f = Constant((0, 0, 0))

V = VectorFunctionSpace(mesh, "Lagrange", 1)

# --------------- Handle Neumann-problem --------------- #
R = FunctionSpace(mesh, 'R', 0)        		 # space for one Lagrange multiplier
M = MixedFunctionSpace([R]*6)          		 # space for all multipliers
W = MixedFunctionSpace([V, M])
u, mus = TrialFunctions(W)
v, nus = TestFunctions(W)

# Establish a basis for the nullspace of RM
e0 = Constant((1, 0, 0))				# translations
e1 = Constant((0, 1, 0))
e2 = Constant((0, 0, 1))

e3 = Expression(('-x[1]', 'x[0]', '0')) # rotations
e4 = Expression(('-x[2]', '0', 'x[0]'))
e5 = Expression(('0', '-x[2]', 'x[1]'))
basis_vectors = [e0, e1, e2, e3, e4, e5]

a = 2*mu*inner(epsilon(u),epsilon(v))*dx + lambda_*inner(div(u),div(v))*dx
L = inner(f, v)*dx + p_outside*inner(n,v)*ds(1)

# Lagrange multipliers contrib to a
for i, e in enumerate(basis_vectors):
	mu = mus[i]
	nu = nus[i]
	a += mu*inner(v, e)*dx + nu*inner(u, e)*dx

# -------------------------------------------------------- #

# Assemble the system
A = PETScMatrix()
b = PETScVector()
assemble_system(a, L, A_tensor=A, b_tensor=b)

# Solve
uh = Function(W)
solver = PETScLUSolver('mumps') # NOTE: we use direct solver for simplicity
solver.set_operator(A)
solver.solve(uh.vector(), b)

# Split displacement and multipliers. Plot
u, ls = uh.split(deepcopy=True) 
plot(u, mode='displacement', title='Neumann_displacement',interactive=True)

file = File('deformed_brain.pvd')
file << u

\end{python}

\subsection{Results}

 \begin{figure}[h!] 
\begin{center}
  \includegraphics[scale=0.4]{brain.png}
  \end{center}
  \caption{Numerical solution using FEniCS. Displacement measured in $mm$.}
\end{figure}

\bibliographystyle{plain}
\bibliography{./papers}


\end{document}
